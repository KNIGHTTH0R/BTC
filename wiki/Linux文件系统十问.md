
***
> 引自 http://djt.qq.com/article/view/620  

**文件的block**

实验表明，操作系统分配空间时是以block为最小单位。也就是说只要你的文件数据不为空，操作系统就至少会给你分配一个block来存储，直到你超过了4KB，操作系统再给你分配下一个block，就是这样。所以对于开篇问题8，新建一个内容大小为1k的文件，实际会占用1个block（一般为4k）和一个inode（一般为256byte）。

　　其实文件系统在向磁盘发起IO请求的时候，也是以block size为单位的。哪怕你只向操作系统发起读取文件的2Byte，但是操作系统会一次性给你读取4KB回来。因此磁盘IO真的是很慢，而且我们只要访问了这2Byte，确实很有可能接下来继续访问这2byte后面的内容，这也就是程序局部性原理，所以操作系统索性一次性就多读取些回来了。

　  我们攻城狮怎么样设计你的文件能提高一些IO速度呢？那就是如果你知道你的要新建的文件大概会占用多大的空间的话，比如1M。那么你新建文件时就顺便和操作系统说一下，让它帮你将文件的size预留下来。这样实际上操作系统时会尽可能为你分配连续的block，这样你再读取这个文件时，磁头就省去很多寻道时间了，IO速度就显得快多了。   
 
**写在后面的话**

　　前面我们说的都是基于我自己的文件系统，情形是一个block size是4KB，一个inode size是256byte，包括我虚拟机上的inode数量才只有140多万个。这些值实际上不是固定的，你完全可以在格式化你的硬盘的时候设置成其它的值。设置的原则就是看你的硬盘的容量，以及你的用途。

　　如果你的文件都是大于4KB，甚至是几M，几G的文件，那么建议你的block还是尽可能的大一点吧，这样inode里就能少记几个地址。

　　如果你的文件大部分都是1K以下的，那么确实使用4K的block会造成一点点浪费，如果你的老板对成本要求异常苛刻的话，你可以适当考虑把你的block设置得小一点。

　　另外，要关注你的文件系统的inode。操作系统在查看目录和文件占用的磁盘空间信息时把inode节点的占用给隐藏起来了，其用意在于为用户提供一个白盒的环境，把数据占用的空间交给我们来认知，而把inode信息隐藏起来为了降低我们理解操作系统的难度。而实际上，我们作为非普通用户的开发人员应该具备这个知情权。这个东东直接关系到你文件系统能创建文件数量。否则哪天等你发现线上机器磁盘还剩大把大把的空间，但就是inode使用光了，那时候就只有重新格式化或者迁移服务器了。这两个操作想想都觉得苦逼啊，还是能避免就尽量避免吧。   
 
 
　　思考题：我们大家有个经验就是目录下小文件太多的情况下，往其它地方拷贝的话，速度会非常的慢，我们这时往往会把目录压缩一下再拷贝。现在你能说出这样做为什么会快吗？